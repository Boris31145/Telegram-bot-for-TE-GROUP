"""
Agent-style Q&A handler (no LLM required).

Goal: when user is NOT inside the order funnel, the bot can answer simple
questions about delivery + customs clearance and route the user to /start.
"""

from __future__ import annotations

import re
from typing import Final

from aiogram import F, Router
from aiogram.filters import Command, StateFilter
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup, Message

from bot.llm import answer_with_openai


router = Router()


def _actions_kb() -> InlineKeyboardMarkup:
    # callbacks are implemented in funnel router
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üì¶ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É", callback_data="action:restart")],
            [InlineKeyboardButton(text="üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º", callback_data="action:call")],
        ]
    )


# ‚îÄ‚îÄ Very small knowledge base ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

FAQ: Final[list[tuple[re.Pattern[str], str]]] = [
    (
        re.compile(r"\b(—Ç–∞–º–æ–∂–Ω|—Ä–∞—Å—Ç–∞–º–æ–∂|–¥–µ–∫–ª–∞—Ä–∞—Ü|–ø–æ—à–ª–∏–Ω|–∫–æ–¥\s*—Ç–Ω\s*–≤—ç–¥|—Ç–Ω–≤—ç–¥)\b", re.I),
        (
            "<b>–¢–∞–º–æ–∂–Ω—è / —Ä–∞—Å—Ç–∞–º–æ–∂–∫–∞</b>\n"
            "–û–±—ã—á–Ω–æ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –Ω—É–∂–Ω—ã:\n"
            "‚Äî –∏–Ω–≤–æ–π—Å (—Å —Ü–µ–Ω–æ–π)\n"
            "‚Äî —É–ø–∞–∫–æ–≤–æ—á–Ω—ã–π –ª–∏—Å—Ç\n"
            "‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç/—Å—á—ë—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)\n"
            "‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ + —Ñ–æ—Ç–æ/—Å—Å—ã–ª–∫–∏\n"
            "‚Äî –∫–æ–¥ –¢–ù –í–≠–î (–º—ã –ø–æ–º–æ–∂–µ–º –ø–æ–¥–æ–±—Ä–∞—Ç—å)\n\n"
            "–ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å–ª–æ–∂–Ω—ã–π (–±—Ä–µ–Ω–¥—ã, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, —Ö–∏–º–∏—è) ‚Äî –º–æ–≥—É—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è "
            "—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã/—Ä–∞–∑—Ä–µ—à–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.\n"
            "–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä –∏ –∏–∑ –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω—ã ‚Äî –ø–æ–¥—Å–∫–∞–∂—É, —á—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è."
        ),
    ),
    (
        re.compile(r"\b(–∏–Ω–∫–æ—Ç–µ—Ä–º—Å|exw|fob|cif|ddp)\b", re.I),
        (
            "<b>–ò–Ω–∫–æ—Ç–µ—Ä–º—Å</b>\n"
            "–ö–æ—Ä–æ—Ç–∫–æ:\n"
            "‚Äî EXW: –≤—ã –∑–∞–±–∏—Ä–∞–µ—Ç–µ —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞\n"
            "‚Äî FOB: –ø–æ—Å—Ç–∞–≤—â–∏–∫ –¥–æ–≤–æ–∑–∏—Ç –¥–æ –ø–æ—Ä—Ç–∞\n"
            "‚Äî CIF: –¥–æ –ø–æ—Ä—Ç–∞ + —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞\n"
            "‚Äî DDP: ‚Äú–¥–æ –¥–≤–µ—Ä–∏‚Äù —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º\n\n"
            "–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ ¬´–ù–µ –∑–Ω–∞—é / –ø–æ–º–æ—á—å¬ª –≤ –∑–∞—è–≤–∫–µ, –º–µ–Ω–µ–¥–∂–µ—Ä —É—Ç–æ—á–Ω–∏—Ç."
        ),
    ),
    (
        re.compile(r"\b(–æ–ø–∞—Å–Ω|dg|adr|imdg|iata)\b", re.I),
        (
            "<b>–û–ø–∞—Å–Ω—ã–π –≥—Ä—É–∑ (DG)</b>\n"
            "–ù—É–∂–Ω—ã: MSDS/SDS, UN –Ω–æ–º–µ—Ä, –∫–ª–∞—Å—Å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —É–ø–∞–∫–æ–≤–∫–∞/–º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞.\n"
            "–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä + –µ—Å—Ç—å –ª–∏ SDS ‚Äî —Å–∫–∞–∂—É, —á—Ç–æ –º–æ–∂–Ω–æ –∏ –∫–∞–∫–∏–º —Å–ø–æ—Å–æ–±–æ–º."
        ),
    ),
    (
        re.compile(r"\b(–∞–∫–∫—É–º|–±–∞—Ç–∞—Ä–µ|li[-\s]?ion|–ª–∏—Ç–∏–µ–≤)\b", re.I),
        (
            "<b>–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã / Li-ion</b>\n"
            "–≠—Ç–æ —á–∞—Å—Ç–æ –ø–æ–ø–∞–¥–∞–µ—Ç –ø–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∞–≤–∏–∞/–ø–æ—á—Ç—ã.\n"
            "–ù—É–∂–Ω–æ: —Ç–∏–ø –±–∞—Ç–∞—Ä–µ–∏, —ë–º–∫–æ—Å—Ç—å (Wh), –≤ —Å–æ—Å—Ç–∞–≤–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ.\n"
            "–ù–∞–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ ‚Äî –ø–æ–¥—Å–∫–∞–∂—É —Ä–µ–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–æ—Å—Ç–∞–≤–∫–∏."
        ),
    ),
    (
        re.compile(r"\b(—Å—Ä–æ–∫|—Å–∫–æ–ª—å–∫–æ\s+–¥–Ω|–±—ã—Å—Ç—Ä|—Å—Ä–æ—á–Ω|–∞–≤–∏–∞|—Å–∞–º–æ–ª[–µ—ë]—Ç)\b", re.I),
        (
            "<b>–°—Ä–æ–∫–∏</b>\n"
            "–ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Å—Ä–æ–∫ 3‚Äì6 –¥–Ω–µ–π ‚Äî —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ–≥–¥–∞ <b>–∞–≤–∏–∞</b>.\n"
            "–≠–∫—Å–ø—Ä–µ—Å—Å 7‚Äì12 –¥–Ω–µ–π ‚Äî —á–∞—â–µ –∂/–¥ –∏–ª–∏ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª.\n"
            "–°—Ç–∞–Ω–¥–∞—Ä—Ç 15‚Äì25 –¥–Ω–µ–π ‚Äî –º–æ—Ä–µ/–∞–≤—Ç–æ.\n\n"
            "–ú–æ–≥—É –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω–µ–µ: —Å—Ç—Ä–∞–Ω–∞ ‚Üí –≥–æ—Ä–æ–¥ ‚Üí —Ç–∏–ø –≥—Ä—É–∑–∞ ‚Üí –≤–µ—Å/–æ–±—ä—ë–º."
        ),
    ),
]


@router.message(Command("faq"))
async def cmd_faq(message: Message) -> None:
    await message.answer(
        "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º (–¥–æ—Å—Ç–∞–≤–∫–∞/—Ç–∞–º–æ–∂–Ω—è/–¥–æ–∫—É–º–µ–Ω—Ç—ã/–ò–Ω–∫–æ—Ç–µ—Ä–º—Å/–æ–ø–∞—Å–Ω—ã–π –≥—Ä—É–∑).\n"
        "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É¬ª.",
        reply_markup=_actions_kb(),
    )


@router.message(StateFilter(None), F.text, ~F.text.startswith("/"))
async def agent_answer(message: Message) -> None:
    text = (message.text or "").strip()
    if not text:
        return

    for pattern, answer in FAQ:
        if pattern.search(text):
            await message.answer(answer, reply_markup=_actions_kb())
            return

    llm = await answer_with_openai(text)
    if llm:
        await message.answer(llm, reply_markup=_actions_kb())
        return

    await message.answer(
        "–ü–æ–Ω—è–ª. –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞:\n"
        "1) —á—Ç–æ –∑–∞ —Ç–æ–≤–∞—Ä\n"
        "2) –æ—Ç–∫—É–¥–∞ (—Å—Ç—Ä–∞–Ω–∞/–≥–æ—Ä–æ–¥)\n"
        "3) –≤–µ—Å –∏ –æ–±—ä—ë–º\n"
        "4) –Ω—É–∂–Ω–∞ –ª–∏ —Ç–∞–º–æ–∂–Ω—è\n\n"
        "–õ–∏–±–æ –Ω–∞–∂–º–∏—Ç–µ ¬´–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É¬ª ‚Äî —Ç–∞–º —è –∑–∞–¥–∞–º –≤–æ–ø—Ä–æ—Å—ã –ø–æ —à–∞–≥–∞–º.",
        reply_markup=_actions_kb(),
    )

